---
- name: Get the latest CiviCRM version number
  local_action:
    module: uri
    url: http://latest.civicrm.org/stable.php
    return_content: yes
  run_once: true
  register: civi_ver

- block:
  - name: check installed CiviCRM version
    command: mysql {{ crm_db_name }} -N -s -e'SELECT version from civicrm_domain WHERE id = 1'
    become: yes
    register: installed_version
    changed_when: false

  - name: Find old database backups
    find:
      age: 1d
      path: "{{ webroot }}/../sql-dumps"
      patterns: "{{ crm_db_name }}.pre-*.sql.gz"
      age_stamp: ctime
    register: old_db_backups

  - name: Delete old database backups
    file:
      path: "{{ item.path }}"
      state: absent
    with_items: "{{ old_db_backups.files }}"
    when: old_db_backups.files is defined and old_db_backups.matched > 0

  - name: Check if db already exists
    stat:
      path: "{{ webroot }}/../sql-dumps/{{ crm_db_name }}.pre-{{civi_ver.content}}.sql.gz"
    become: yes
    register: existing_backup

  - name: Back up the databases
    mysql_db:
      state: dump
      name: "{{ crm_db_name }}"
      target: "{{ webroot }}/../sql-dumps/{{ crm_db_name }}.pre-{{civi_ver.content}}.sql.gz"
    become: yes
    when: existing_backup.stat is defined and existing_backup.stat.exists == false

  - name: git pull
    command: git pull
    args:
      chdir: "{{ civiroot }}"
    become: yes
    become_user: "{{ run_as_user }}"
    register: pull_result
    changed_when:  pull_result.stdout != 'Already up-to-date.'

  # This is broken on WP if you just upgraded the db. Checking in with Christian Wach on 8/29/18.
  - name: Upgrade the Civi DB
    command: "cv -n upgrade:db --cwd {{ webroot }}"
    become: yes
    become_user: "{{ run_as_user }}"
    when: installed_version.stdout != civi_ver.content

  when: contract_type is search("Civi Maintenance") and freeze_crm != "1"
